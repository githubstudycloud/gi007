# 双NAS家庭服务器部署方案

## 整体架构

```
                              ┌──────────────────────────┐
                              │      互联网 / 云服务      │
                              │  (GitHub, 云盘, 远程)     │
                              └───────────┬──────────────┘
                                          │
                                   ┌──────┴──────┐
                                   │   路由器     │
                                   │ (主网关)     │
                                   └──────┬──────┘
                                          │
            ┌─────────────────────────────┼─────────────────────────────┐
            │                             │                             │
            │         ┌───────────────────┴───────────────────┐         │
            │         │           内网交换机/AP               │         │
            │         │        (千兆/2.5G/万兆)               │         │
            │         └───────────────────┬───────────────────┘         │
            │                             │                             │
     ┌──────┴──────┐               ┌──────┴──────┐               ┌──────┴──────┐
     │             │               │             │               │             │
     │  极空间Z423 │<─── 同步 ───>│绿联4800Plus │               │  客户端设备  │
     │  (开发主力) │               │  (媒体中心) │               │             │
     │             │               │             │               │             │
     └─────────────┘               └─────────────┘               └─────────────┘
           │                             │                             │
           │    ┌────────────────────────┴─────────────────────────────┤
           │    │                                                      │
           ▼    ▼                                                      ▼
    ┌─────────────────┐                                    ┌─────────────────────┐
    │   开发服务      │                                    │     客户端          │
    │ - GitLab        │                                    │ - Mac Mini          │
    │ - Jenkins       │                                    │ - 笔记本 x2         │
    │ - 数据库集群    │                                    │ - 主机              │
    │ - 中间件        │                                    │ - 手机/平板         │
    └─────────────────┘                                    └─────────────────────┘
```

---

## 设备清单

### NAS设备

| 设备 | 角色定位 | 存储容量 | 主要用途 |
|------|----------|----------|----------|
| 极空间 Z423 (64GB) | 开发主力机 | 2T+1T SSD, 8+16+18T HDD | 开发环境、数据库、CI/CD |
| 绿联 DXP4800 Plus | 媒体中心 | 2T+2T(QLC) SSD, 8+8+14+18T HDD | 媒体服务、智能家居、家庭备份 |

### 客户端设备

| 设备 | 主要用途 | 与NAS的交互 |
|------|----------|-------------|
| Mac Mini | 主力开发机 | SSH到极空间、媒体播放、Time Machine |
| 笔记本 x2 | 移动办公/备用 | 文件同步、备份、媒体访问 |
| 主机 | 游戏/重度任务 | 游戏存档同步、大文件传输 |
| 手机/平板 | 日常使用 | 照片同步、媒体流、文件访问 |

---

## 服务分工

### 极空间 Z423 - 开发与生产服务

| 分类 | 服务 | 说明 |
|------|------|------|
| **代码管理** | GitLab | 私有代码托管 |
| | Harbor | Docker镜像仓库 |
| **CI/CD** | Jenkins | 持续集成 |
| | Drone | 轻量级CI |
| **开发工具** | code-server | 在线IDE |
| | Jupyter | 数据分析 |
| **数据库** | MySQL 8 | 主数据库 |
| | PostgreSQL 16 | 分析数据库 |
| | MongoDB 7 | 文档数据库 |
| | Redis 7 | 缓存 |
| | Elasticsearch | 全文检索 |
| **中间件** | Nacos | 服务注册 |
| | Sentinel | 限流熔断 |
| | XXL-Job | 任务调度 |
| | RabbitMQ | 消息队列 |
| | MinIO | 对象存储 |
| **监控** | Prometheus | 指标采集 |
| | Grafana | 可视化 |
| | Loki | 日志聚合 |

### 绿联 DXP4800 Plus - 媒体与家庭服务

| 分类 | 服务 | 说明 |
|------|------|------|
| **媒体** | Jellyfin | 主媒体服务器 |
| | Plex | 备用(iOS兼容好) |
| | Navidrome | 音乐流媒体 |
| | Immich | 照片管理 |
| | Kavita | 电子书/漫画 |
| **下载** | qBittorrent | BT下载 |
| | Aria2 | 多协议下载 |
| | Sonarr/Radarr | 自动追剧 |
| **智能家居** | Home Assistant | 智能家居中枢 |
| | Homebridge | HomeKit桥接 |
| | Node-RED | 自动化 |
| **家庭服务** | Nextcloud | 家庭云盘 |
| | Vaultwarden | 密码管理 |
| | Syncthing | 设备同步 |
| **网络** | AdGuard Home | DNS/广告过滤 |
| | Tailscale | 远程访问 |

---

## 存储规划总览

### 极空间 Z423 存储分配

```
总容量: 45TB (2+1TB SSD + 8+16+18TB HDD)

SSD层 (3TB):
├── 系统与开发环境 ──── 2TB主SSD
│   ├── 系统/Docker: 200GB
│   ├── 开发工作区: 800GB
│   ├── 数据库: 500GB
│   └── 缓存池: 500GB
└── 高频服务 ────────── 1TB副SSD
    ├── Elasticsearch: 300GB
    ├── MinIO热数据: 300GB
    ├── GitLab: 200GB
    └── Jenkins: 200GB

HDD层 (42TB):
├── 开发存储 ────────── 8TB
│   ├── Git仓库: 2TB
│   ├── 容器镜像: 1TB
│   ├── 构建产物: 1TB
│   ├── 数据集: 2TB
│   ├── VM镜像: 1TB
│   └── 备份: 1TB
├── 媒体与备份 ──────── 16TB
│   ├── 媒体库: 10TB
│   ├── 设备备份: 4TB
│   └── 文档: 2TB
└── 冷存储 ──────────── 18TB
    ├── 项目归档: 8TB
    ├── 原始素材: 5TB
    ├── ISO镜像: 2TB
    ├── 历史数据: 2TB
    └── 灾备: 1TB
```

### 绿联 DXP4800 Plus 存储分配

```
总容量: 44TB (2+2TB SSD + 8+8+14+18TB HDD)

SSD层 (4TB):
├── 系统盘 ──────────── 2TB TLC
│   ├── 系统/Docker: 100GB
│   ├── 应用数据: 200GB
│   ├── 下载临时: 500GB
│   ├── 转码缓存: 500GB
│   └── 热数据: 700GB
└── 只读缓存盘 ──────── 2TB QLC ⚠️
    ├── 媒体元数据: 1TB
    ├── 静态资源: 500GB
    └── 读取缓存: 500GB

HDD层 (48TB, RAID后约40TB):
├── 关键数据池 ──────── 8TB (RAID1镜像)
│   ├── 家庭保险箱: 3TB
│   ├── 备份仓库: 3TB
│   └── 加密存储: 2TB
├── 媒体库A ──────────── 14TB (二手盘⚠️)
│   ├── 电影: 6TB
│   ├── 剧集: 5TB
│   └── 动漫: 3TB
└── 媒体库B+归档 ────── 18TB (企业盘)
    ├── 媒体溢出: 8TB
    ├── 原始归档: 5TB
    ├── 冷数据: 3TB
    └── 灾备: 2TB
```

---

## 数据流向

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            数据流向图                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────┐                                       ┌──────────┐       │
│  │ 手机照片 │ ────────PhotoSync────────────────> │ Immich   │       │
│  └──────────┘                                       │ (绿联)   │       │
│                                                     └────┬─────┘       │
│                                                          │             │
│                                                     Syncthing          │
│                                                          │             │
│                                                          ▼             │
│                                                     ┌──────────┐       │
│                                                     │ PhotoPrism│      │
│                                                     │  (极空间)  │      │
│                                                     └──────────┘       │
│                                                                         │
│  ┌──────────┐      Git Push       ┌──────────┐    rsync备份            │
│  │ 开发代码 │ ──────────────────> │  GitLab  │ ──────────────────>     │
│  │ (本地)   │                     │ (极空间) │                         │
│  └──────────┘                     └──────────┘    ┌──────────┐         │
│                                                    │ 灾备副本 │         │
│                                                    │ (绿联)   │         │
│                                                    └──────────┘         │
│                                                                         │
│  ┌──────────┐                     ┌──────────┐                         │
│  │ 下载任务 │ ──────────────────> │qBittorrent│                        │
│  └──────────┘                     │  (绿联)   │                        │
│                                   └─────┬────┘                         │
│                                         │                              │
│                                    自动分类                             │
│                                         │                              │
│                                         ▼                              │
│                                   ┌──────────┐      SMB/NFS           │
│                                   │ 媒体库   │ <────────────────       │
│                                   │ (绿联)   │                    │    │
│                                   └─────┬────┘                    │    │
│                                         │                         │    │
│                                    Jellyfin                       │    │
│                                         │                         │    │
│                                         ▼                         │    │
│                   ┌─────────────────────────────────────────┐    │    │
│                   │              所有客户端                  │<───┘    │
│                   │ Mac Mini | 笔记本 | 主机 | 手机/平板    │         │
│                   └─────────────────────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 网络规划

### IP分配建议

| 设备/服务 | IP地址 | 说明 |
|-----------|--------|------|
| 路由器 | 192.168.1.1 | 网关 |
| 极空间 Z423 | 192.168.1.100 | 静态IP |
| 绿联 4800Plus | 192.168.1.101 | 静态IP |
| Mac Mini | 192.168.1.50 | DHCP保留 |
| AdGuard Home | 192.168.1.101:53 | DNS服务 |

### 域名规划

```
*.nas.local          -> 极空间 (开发服务)
*.home.local         -> 绿联 (家庭服务)

示例:
gitlab.nas.local     -> 极空间 GitLab
jenkins.nas.local    -> 极空间 Jenkins
media.home.local     -> 绿联 Jellyfin
photos.home.local    -> 绿联 Immich
```

---

## 备份策略

### 3-2-1原则实施

```
数据类型        │  主存储位置  │  本地备份位置  │  异地备份
───────────────┼─────────────┼───────────────┼────────────
代码仓库        │ 极空间GitLab │ 绿联灾备目录  │ GitHub
数据库          │ 极空间SSD   │ 极空间HDD     │ 绿联+云
照片原片        │ 绿联RAID1   │ 极空间同步    │ 云相册
家庭文档        │ 绿联RAID1   │ 极空间同步    │ OneDrive
媒体文件        │ 绿联HDD     │ 无(可重获)    │ 无
设备备份        │ 绿联RAID1   │ -             │ -
```

### 自动备份任务

| 任务 | 频率 | 源 | 目标 |
|------|------|----|----|
| 数据库备份 | 每日 | 极空间MySQL/PG | 极空间HDD + 绿联 |
| GitLab备份 | 每日 | 极空间GitLab | 绿联灾备 |
| 照片同步 | 实时 | 绿联Immich | 极空间PhotoPrism |
| 配置备份 | 每周 | 两台NAS | 互相备份 |

---

## 快速部署清单

### 第一阶段: 基础设施 (第1-2天)

- [ ] 硬盘分区和存储池创建
- [ ] Docker环境配置
- [ ] 网络配置(静态IP、DNS)
- [ ] Portainer部署
- [ ] Traefik/NPM反向代理

### 第二阶段: 极空间开发环境 (第3-5天)

- [ ] 数据库集群(MySQL, PostgreSQL, MongoDB, Redis)
- [ ] GitLab代码托管
- [ ] Jenkins CI/CD
- [ ] code-server在线IDE
- [ ] 中间件(Nacos, RabbitMQ等)

### 第三阶段: 绿联媒体中心 (第6-8天)

- [ ] Jellyfin媒体服务器
- [ ] Immich照片管理
- [ ] qBittorrent + Sonarr/Radarr
- [ ] Navidrome音乐服务

### 第四阶段: 家庭与网络服务 (第9-10天)

- [ ] AdGuard Home DNS
- [ ] Home Assistant智能家居
- [ ] Nextcloud家庭云盘
- [ ] Vaultwarden密码管理
- [ ] Syncthing设备同步

### 第五阶段: 监控与备份 (第11-12天)

- [ ] Prometheus + Grafana监控
- [ ] 备份脚本配置
- [ ] SMART硬盘监控
- [ ] Tailscale远程访问

### 第六阶段: 客户端配置 (第13-14天)

- [ ] Mac Mini配置
- [ ] 笔记本/主机配置
- [ ] 手机/平板App安装
- [ ] 同步和备份验证

---

## 文档索引

| 文档 | 说明 |
|------|------|
| [01-极空间Z423部署方案.md](01-极空间Z423部署方案.md) | 极空间详细配置 |
| [02-绿联DXP4800Plus部署方案.md](02-绿联DXP4800Plus部署方案.md) | 绿联详细配置 |
| [03-反向代理与导航配置.md](03-反向代理与导航配置.md) | NPM + Homepage + Uptime Kuma + cpolar |
| [04-Docker自托管项目推荐.md](04-Docker自托管项目推荐.md) | 100+实用项目清单 |

---

## 注意事项

### 硬件风险提示

1. **QLC固态 (绿联2TB)**
   - 写入寿命有限,避免高频写入
   - 只用于读缓存和元数据存储
   - 定期监控磨损度

2. **二手红盘 (绿联14TB)**
   - 每周执行SMART短测试
   - 每月执行SMART长测试
   - 不存储关键数据
   - 设置告警阈值

3. **RAID建议**
   - 绿联双8TB红盘Plus做RAID1保护关键数据
   - 不同批次/型号硬盘不建议组RAID
   - 媒体数据不需要RAID保护

### 服务依赖关系

```
启动顺序:
1. 网络服务 (DNS, 反向代理)
2. 数据库服务
3. 中间件服务
4. 应用服务
5. 监控服务
```

### 资源预留

- 极空间64GB内存预留14GB给系统
- 绿联预留适当内存给UGOS系统
- Docker日志限制防止磁盘占满
- 定期清理构建缓存和临时文件
