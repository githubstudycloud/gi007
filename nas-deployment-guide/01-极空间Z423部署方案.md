# 极空间 Z423 标准版部署方案

## 硬件概览

| 组件 | 规格 | 用途定位 |
|------|------|----------|
| 内存 | 64GB DDR4 | 支持大量Docker容器和虚拟机 |
| 固态1 | 2TB NVMe | 系统盘 + 热数据缓存 + 开发环境 |
| 固态2 | 1TB NVMe | 数据库 + 高频读写服务 |
| 机械1 | 8TB | 开发项目 + 代码仓库 |
| 机械2 | 16TB | 媒体库 + 备份 |
| 机械3 | 18TB | 冷数据归档 + 大文件存储 |

---

## 一、存储空间分配方案

### 1.1 固态硬盘分配 (2TB + 1TB)

#### 2TB 固态 - 系统与开发盘
```
/volume1/ssd-main/
├── system/              # 200GB - 系统及Docker
│   ├── docker/          # Docker数据目录
│   └── apps/            # 应用数据
├── dev-workspace/       # 800GB - 开发工作区
│   ├── projects/        # 当前活跃项目
│   ├── build-cache/     # Maven/npm/Go缓存
│   └── venv/            # Python虚拟环境
├── databases/           # 500GB - 数据库文件
│   ├── mysql/
│   ├── postgresql/
│   ├── mongodb/
│   └── redis/
└── cache/               # 500GB - SSD缓存池
    ├── download-temp/   # 下载临时目录
    └── transcode/       # 视频转码缓存
```

#### 1TB 固态 - 高频服务盘
```
/volume2/ssd-fast/
├── elasticsearch/       # 300GB - ES索引
├── minio-hot/           # 300GB - 对象存储热数据
├── gitlab-data/         # 200GB - GitLab仓库数据
└── jenkins-workspace/   # 200GB - CI/CD工作空间
```

### 1.2 机械硬盘分配

#### 8TB 机械 - 开发存储
```
/volume3/dev-storage/
├── git-repos/           # 2TB - 所有Git仓库镜像
├── container-registry/  # 1TB - 私有Docker镜像
├── artifacts/           # 1TB - 构建产物归档
├── datasets/            # 2TB - 机器学习数据集
├── vm-images/           # 1TB - 虚拟机镜像
└── backups/             # 1TB - 开发环境备份
```

#### 16TB 机械 - 媒体与备份
```
/volume4/media-backup/
├── media/               # 10TB
│   ├── movies/          # 电影库
│   ├── tv-shows/        # 剧集库
│   ├── music/           # 音乐库
│   └── photos/          # 照片库
├── backups/             # 4TB
│   ├── mac-timemachine/ # Mac Time Machine
│   ├── pc-backup/       # PC备份
│   └── phone-sync/      # 手机同步
└── documents/           # 2TB - 文档归档
```

#### 18TB 机械 - 冷存储
```
/volume5/cold-storage/
├── archive/             # 8TB - 历史项目归档
├── raw-footage/         # 5TB - 原始视频素材
├── iso-images/          # 2TB - 系统镜像收藏
├── dataset-archive/     # 2TB - 历史数据集
└── disaster-recovery/   # 1TB - 灾备镜像
```

---

## 二、服务部署方案

### 2.1 核心服务架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     极空间 Z423 (主力开发机)                      │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   Traefik   │  │   Portainer │  │  Watchtower │            │
│  │  反向代理    │  │  容器管理    │  │  自动更新    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│                        开发环境层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   GitLab    │  │   Jenkins   │  │   Harbor    │            │
│  │  代码托管    │  │   CI/CD     │  │  镜像仓库    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  code-server│  │   Jupyter   │  │   Drone     │            │
│  │  在线IDE    │  │  数据分析    │  │  轻量CI     │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│                        数据服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   MySQL 8   │  │  PostgreSQL │  │   MongoDB   │            │
│  │   主数据库   │  │  分析数据库  │  │  文档数据库  │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │    Redis    │  │Elasticsearch│  │    MinIO    │            │
│  │    缓存     │  │   全文检索   │  │  对象存储    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│                        应用服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  Nacos      │  │   Sentinel  │  │   XXL-Job   │            │
│  │  服务注册    │  │   限流熔断   │  │  任务调度    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│  ┌─────────────┐  │  ┌─────────────┐  ┌─────────────┐         │
│  │   RabbitMQ  │  │  │    Kafka    │  │    Nginx    │         │
│  │   消息队列   │  │  │   事件流    │  │   Web服务   │          │
│  └─────────────┘  │  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────────┤
│                        娱乐服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   Jellyfin  │  │   Navidrome │  │  PhotoPrism │            │
│  │  视频媒体    │  │   音乐流媒体 │  │   智能相册   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   qBittorrent│ │   Aria2     │  │  Alist      │            │
│  │   BT下载    │  │  多协议下载  │  │  网盘聚合    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│                        监控运维层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  Prometheus │  │   Grafana   │  │   Loki      │            │
│  │  指标采集    │  │   可视化     │  │   日志聚合   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 资源分配建议

| 服务类别 | 内存分配 | CPU配额 | 优先级 |
|----------|----------|---------|--------|
| 数据库服务 | 16GB | 4核 | 高 |
| 开发工具 | 12GB | 4核 | 高 |
| 应用中间件 | 8GB | 2核 | 中 |
| 媒体服务 | 8GB | 2核 | 中 |
| 监控运维 | 4GB | 1核 | 低 |
| 下载服务 | 2GB | 1核 | 低 |
| 系统预留 | 14GB | - | - |

---

## 三、Docker Compose 配置

### 3.1 基础设施层

```yaml
# docker-compose.infra.yml
version: '3.8'

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=your@email.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
    networks:
      - traefik-net

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.nas.local`)"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
    networks:
      - traefik-net

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - WATCHTOWER_NOTIFICATIONS=email

volumes:
  portainer_data:

networks:
  traefik-net:
    external: true
```

### 3.2 开发环境层

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    restart: always
    hostname: 'gitlab.nas.local'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.nas.local'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        gitlab_rails['time_zone'] = 'Asia/Shanghai'
        # 性能优化
        puma['worker_processes'] = 2
        sidekiq['concurrency'] = 10
        postgresql['shared_buffers'] = "512MB"
        prometheus_monitoring['enable'] = false
    ports:
      - '2222:22'
    volumes:
      - /volume2/ssd-fast/gitlab-data/config:/etc/gitlab
      - /volume2/ssd-fast/gitlab-data/logs:/var/log/gitlab
      - /volume2/ssd-fast/gitlab-data/data:/var/opt/gitlab
    shm_size: '256m'
    deploy:
      resources:
        limits:
          memory: 4G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=Host(`gitlab.nas.local`)"
      - "traefik.http.services.gitlab.loadbalancer.server.port=80"
    networks:
      - traefik-net
      - dev-net

  jenkins:
    image: jenkins/jenkins:lts-jdk17
    container_name: jenkins
    restart: always
    user: root
    environment:
      - JAVA_OPTS=-Xmx2g -Xms1g
    volumes:
      - /volume2/ssd-fast/jenkins-workspace:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker
    deploy:
      resources:
        limits:
          memory: 3G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jenkins.rule=Host(`jenkins.nas.local`)"
      - "traefik.http.services.jenkins.loadbalancer.server.port=8080"
    networks:
      - traefik-net
      - dev-net

  code-server:
    image: lscr.io/linuxserver/code-server:latest
    container_name: code-server
    restart: always
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
      - PASSWORD=your_password
      - SUDO_PASSWORD=your_sudo_password
      - DEFAULT_WORKSPACE=/workspace
    volumes:
      - /volume1/ssd-main/dev-workspace/projects:/workspace
      - ./code-server/config:/config
    deploy:
      resources:
        limits:
          memory: 2G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.code.rule=Host(`code.nas.local`)"
      - "traefik.http.services.code.loadbalancer.server.port=8443"
    networks:
      - traefik-net

  jupyter:
    image: jupyter/datascience-notebook:latest
    container_name: jupyter
    restart: always
    environment:
      - JUPYTER_TOKEN=your_token
    volumes:
      - /volume1/ssd-main/dev-workspace/projects:/home/jovyan/work
      - /volume3/dev-storage/datasets:/home/jovyan/datasets
    deploy:
      resources:
        limits:
          memory: 4G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jupyter.rule=Host(`jupyter.nas.local`)"
      - "traefik.http.services.jupyter.loadbalancer.server.port=8888"
    networks:
      - traefik-net

  harbor:
    # Harbor 需要单独部署，使用官方安装脚本
    # 这里只是占位说明
    image: goharbor/harbor-core:v2.10.0
    container_name: harbor
    # 详见 Harbor 官方部署文档

networks:
  traefik-net:
    external: true
  dev-net:
    driver: bridge
```

### 3.3 数据库层

```yaml
# docker-compose.database.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: dev
      TZ: Asia/Shanghai
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=2G
      - --innodb-log-file-size=256M
      - --max-connections=500
      - --slow-query-log=1
      - --long-query-time=2
    volumes:
      - /volume1/ssd-main/databases/mysql:/var/lib/mysql
      - ./mysql/conf.d:/etc/mysql/conf.d
      - ./mysql/init:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    deploy:
      resources:
        limits:
          memory: 4G
    networks:
      - db-net

  postgresql:
    image: postgres:16-alpine
    container_name: postgresql
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: dev
      PGDATA: /var/lib/postgresql/data/pgdata
    command:
      - postgres
      - -c
      - shared_buffers=1GB
      - -c
      - effective_cache_size=3GB
      - -c
      - maintenance_work_mem=256MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=16MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
    volumes:
      - /volume1/ssd-main/databases/postgresql:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    deploy:
      resources:
        limits:
          memory: 4G
    networks:
      - db-net

  mongodb:
    image: mongo:7.0
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    command:
      - --wiredTigerCacheSizeGB=2
    volumes:
      - /volume1/ssd-main/databases/mongodb:/data/db
    ports:
      - "27017:27017"
    deploy:
      resources:
        limits:
          memory: 3G
    networks:
      - db-net

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    command:
      - redis-server
      - --maxmemory 2gb
      - --maxmemory-policy allkeys-lru
      - --appendonly yes
      - --appendfsync everysec
    volumes:
      - /volume1/ssd-main/databases/redis:/data
    ports:
      - "6379:6379"
    deploy:
      resources:
        limits:
          memory: 2G
    networks:
      - db-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: elasticsearch
    restart: always
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      - xpack.security.enabled=false
    volumes:
      - /volume2/ssd-fast/elasticsearch:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    deploy:
      resources:
        limits:
          memory: 4G
    networks:
      - db-net

networks:
  db-net:
    driver: bridge
```

### 3.4 中间件层

```yaml
# docker-compose.middleware.yml
version: '3.8'

services:
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: nacos
    restart: always
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_USER=nacos
      - MYSQL_SERVICE_PASSWORD=${NACOS_DB_PASSWORD}
      - MYSQL_SERVICE_DB_NAME=nacos
      - JVM_XMS=512m
      - JVM_XMX=512m
    ports:
      - "8848:8848"
      - "9848:9848"
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - middleware-net
      - db-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nacos.rule=Host(`nacos.nas.local`)"

  sentinel:
    image: bladex/sentinel-dashboard:1.8.6
    container_name: sentinel
    restart: always
    environment:
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8858:8858"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - middleware-net

  xxl-job:
    image: xuxueli/xxl-job-admin:2.4.0
    container_name: xxl-job
    restart: always
    environment:
      PARAMS: |
        --spring.datasource.url=jdbc:mysql://mysql:3306/xxl_job?useUnicode=true&characterEncoding=UTF-8
        --spring.datasource.username=xxl_job
        --spring.datasource.password=${XXL_JOB_PASSWORD}
    ports:
      - "8088:8080"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - middleware-net
      - db-net

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - ./rabbitmq/data:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - middleware-net

  minio:
    image: minio/minio:latest
    container_name: minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    volumes:
      - /volume2/ssd-fast/minio-hot:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - middleware-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`minio.nas.local`)"
      - "traefik.http.services.minio.loadbalancer.server.port=9001"

networks:
  middleware-net:
    driver: bridge
  db-net:
    external: true
```

### 3.5 娱乐服务层

```yaml
# docker-compose.media.yml
version: '3.8'

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: always
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./jellyfin/config:/config
      - ./jellyfin/cache:/cache
      - /volume4/media-backup/media/movies:/media/movies:ro
      - /volume4/media-backup/media/tv-shows:/media/tv:ro
      - /volume1/ssd-main/cache/transcode:/transcode
    ports:
      - "8096:8096"
    devices:
      - /dev/dri:/dev/dri  # 硬件转码
    deploy:
      resources:
        limits:
          memory: 4G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`media.nas.local`)"
    networks:
      - media-net

  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    restart: always
    environment:
      ND_SCANSCHEDULE: 1h
      ND_LOGLEVEL: info
      ND_SESSIONTIMEOUT: 24h
      ND_BASEURL: ""
    volumes:
      - ./navidrome/data:/data
      - /volume4/media-backup/media/music:/music:ro
    ports:
      - "4533:4533"
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.navidrome.rule=Host(`music.nas.local`)"
    networks:
      - media-net

  photoprism:
    image: photoprism/photoprism:latest
    container_name: photoprism
    restart: always
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    environment:
      PHOTOPRISM_ADMIN_PASSWORD: ${PHOTOPRISM_PASSWORD}
      PHOTOPRISM_SITE_URL: "https://photos.nas.local/"
      PHOTOPRISM_ORIGINALS_LIMIT: 5000
      PHOTOPRISM_HTTP_COMPRESSION: "gzip"
      PHOTOPRISM_DATABASE_DRIVER: "mysql"
      PHOTOPRISM_DATABASE_SERVER: "mysql:3306"
      PHOTOPRISM_DATABASE_NAME: "photoprism"
      PHOTOPRISM_DATABASE_USER: "photoprism"
      PHOTOPRISM_DATABASE_PASSWORD: ${PHOTOPRISM_DB_PASSWORD}
    volumes:
      - /volume4/media-backup/media/photos:/photoprism/originals
      - ./photoprism/storage:/photoprism/storage
    ports:
      - "2342:2342"
    deploy:
      resources:
        limits:
          memory: 4G
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.photoprism.rule=Host(`photos.nas.local`)"
    networks:
      - media-net
      - db-net

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: always
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
      - WEBUI_PORT=8081
    volumes:
      - ./qbittorrent/config:/config
      - /volume1/ssd-main/cache/download-temp:/downloads
      - /volume4/media-backup/media:/media
    ports:
      - "8081:8081"
      - "6881:6881"
      - "6881:6881/udp"
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - media-net

  alist:
    image: xhofe/alist:latest
    container_name: alist
    restart: always
    volumes:
      - ./alist/data:/opt/alist/data
    ports:
      - "5244:5244"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.alist.rule=Host(`pan.nas.local`)"
    networks:
      - media-net

networks:
  media-net:
    driver: bridge
  db-net:
    external: true
```

### 3.6 监控运维层

```yaml
# docker-compose.monitor.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus/config:/etc/prometheus
      - ./prometheus/data:/prometheus
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - monitor-net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://grafana.nas.local
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "3000:3000"
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.nas.local`)"
    networks:
      - monitor-net

  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: always
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki/config:/etc/loki
      - ./loki/data:/loki
    ports:
      - "3100:3100"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - monitor-net

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: always
    volumes:
      - ./promtail/config:/etc/promtail
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - monitor-net

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: always
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    ports:
      - "9100:9100"
    deploy:
      resources:
        limits:
          memory: 128M
    networks:
      - monitor-net

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: always
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    ports:
      - "8082:8080"
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - monitor-net

networks:
  monitor-net:
    driver: bridge
```

---

## 四、客户端同步配置

### 4.1 Mac Mini 配置

```bash
# Time Machine 配置
# 在系统设置中添加网络磁盘
smb://nas.local/mac-timemachine

# 开发环境同步 (使用 Syncthing 或 rsync)
# 安装 Syncthing
brew install syncthing

# 或使用 rsync 定期同步
rsync -avz --delete \
  ~/Development/ \
  nas.local:/volume1/ssd-main/dev-workspace/projects/mac-sync/
```

### 4.2 笔记本/主机配置

```powershell
# Windows 备份到 NAS
# 使用 robocopy 同步
robocopy "C:\Users\%USERNAME%\Documents" "\\nas.local\backups\pc-backup\documents" /MIR /R:3 /W:5

# 或配置 Windows 文件历史记录指向 NAS
```

### 4.3 手机/平板同步

推荐应用：
- **照片同步**: PhotoSync (自动同步到 PhotoPrism)
- **文件管理**: 极空间官方App / Solid Explorer
- **媒体播放**: Infuse (iOS) / Jellyfin App (Android/iOS)
- **音乐流媒体**: Navidrome 客户端 (Substreamer / Amperfy)

---

## 五、网络配置建议

### 5.1 内网DNS配置

```bash
# 在路由器或独立DNS服务器配置
# 推荐使用 AdGuard Home 或 Pi-hole

# 域名映射示例
192.168.1.100  nas.local
192.168.1.100  gitlab.nas.local
192.168.1.100  jenkins.nas.local
192.168.1.100  code.nas.local
192.168.1.100  media.nas.local
192.168.1.100  music.nas.local
192.168.1.100  photos.nas.local
192.168.1.100  grafana.nas.local
192.168.1.100  portainer.nas.local
```

### 5.2 远程访问方案

```yaml
# 推荐方案：Tailscale VPN
# 安装 Tailscale 容器
services:
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: zspace-z423
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_EXTRA_ARGS=--advertise-routes=192.168.1.0/24
      - TS_STATE_DIR=/var/lib/tailscale
    volumes:
      - ./tailscale/state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    restart: always
```

---

## 六、备份策略

### 6.1 3-2-1 备份原则

```
数据类型          主存储           本地备份              异地备份
─────────────────────────────────────────────────────────────────
代码仓库          GitLab(SSD)     HDD镜像              GitHub/云端
数据库            SSD             定时快照到HDD         云数据库
照片              PhotoPrism      原图保留HDD           云相册
重要文档          SSD             HDD冗余              OneDrive
媒体文件          HDD             无(可重新获取)        无
```

### 6.2 自动备份脚本

```bash
#!/bin/bash
# /opt/scripts/backup.sh

# 数据库备份
docker exec mysql mysqldump -u root -p${MYSQL_ROOT_PASSWORD} --all-databases > /volume3/dev-storage/backups/mysql_$(date +%Y%m%d).sql
docker exec postgresql pg_dumpall -U postgres > /volume3/dev-storage/backups/postgres_$(date +%Y%m%d).sql

# GitLab 备份
docker exec gitlab gitlab-backup create

# 清理7天前的备份
find /volume3/dev-storage/backups -name "*.sql" -mtime +7 -delete

# 同步到绿联NAS
rsync -avz /volume3/dev-storage/backups/ ugreen:/volume1/disaster-recovery/zspace-backup/
```

---

## 七、性能优化建议

### 7.1 Docker 优化

```json
// /etc/docker/daemon.json
{
  "storage-driver": "overlay2",
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 65536,
      "Soft": 65536
    }
  },
  "live-restore": true,
  "max-concurrent-downloads": 10
}
```

### 7.2 系统参数优化

```bash
# /etc/sysctl.conf
# 网络优化
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.core.netdev_max_backlog = 30000
net.ipv4.tcp_max_syn_backlog = 8192

# 文件系统优化
fs.file-max = 2097152
fs.inotify.max_user_watches = 524288

# 虚拟内存优化
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
```

---

## 八、启动顺序

```bash
# 1. 创建网络
docker network create traefik-net
docker network create db-net

# 2. 启动基础设施
docker compose -f docker-compose.infra.yml up -d

# 3. 启动数据库
docker compose -f docker-compose.database.yml up -d
sleep 30  # 等待数据库就绪

# 4. 启动中间件
docker compose -f docker-compose.middleware.yml up -d

# 5. 启动开发环境
docker compose -f docker-compose.dev.yml up -d

# 6. 启动娱乐服务
docker compose -f docker-compose.media.yml up -d

# 7. 启动监控
docker compose -f docker-compose.monitor.yml up -d
```

---

## 九、服务访问地址汇总

| 服务 | 地址 | 用途 |
|------|------|------|
| Portainer | https://portainer.nas.local | 容器管理 |
| GitLab | https://gitlab.nas.local | 代码托管 |
| Jenkins | https://jenkins.nas.local | CI/CD |
| Code Server | https://code.nas.local | 在线IDE |
| Jupyter | https://jupyter.nas.local | 数据分析 |
| Nacos | https://nacos.nas.local | 服务注册 |
| MinIO | https://minio.nas.local | 对象存储 |
| Jellyfin | https://media.nas.local | 视频媒体 |
| Navidrome | https://music.nas.local | 音乐流媒体 |
| PhotoPrism | https://photos.nas.local | 智能相册 |
| Alist | https://pan.nas.local | 网盘聚合 |
| Grafana | https://grafana.nas.local | 监控面板 |
| RabbitMQ | http://nas.local:15672 | 消息队列管理 |
| Prometheus | http://nas.local:9090 | 指标监控 |
